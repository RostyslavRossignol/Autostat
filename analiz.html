<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä Meta Ads —Å –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –ò–Ω—Å–∞–π—Ç–∞–º–∏ –æ—Ç Gemini</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #f0f8ff, #e6f7ff);
            font-family: 'Inter', sans-serif;
        }
        .card-highlight {
            border-left: .25rem solid #0d6efd;
        }
        th.sortable {
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        th.sortable::after {
            content: '\25B2\25BC';
            font-size: .7em;
            position: absolute;
            right: .5rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(0,0,0,.3);
            transition: color 0.2s;
        }
        th.sortable:hover::after {
            color: rgba(0,0,0,.7);
        }
        .table-hover tbody tr:hover {
            background-color: rgba(13, 110, 253, .075);
        }
        .loader, .gemini-loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #0d6efd;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .gemini-loader {
             width: 32px;
             height: 32px;
             border-width: 4px;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1060;
        }
        .gemini-output {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            border-radius: .5rem;
            padding: 1rem;
        }
        .gemini-output table {
            width: 100%;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border-collapse: collapse;
        }
        .gemini-output th, .gemini-output td {
            border: 1px solid #dee2e6;
            padding: .5rem;
            text-align: left;
        }
        .gemini-output th {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="container py-5">
        <div class="text-center mb-4">
            <h1 class="mb-2 text-primary fw-bold">üéØ –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä Meta Ads —Å –ò–Ω—Å–∞–π—Ç–∞–º–∏ –æ—Ç Gemini</h1>
            <p class="lead text-muted">–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV —Ñ–∞–π–ª—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –æ—Ç –ò–ò.</p>
        </div>

        <!-- File Upload Section -->
        <div class="row mb-5">
            <div class="col-md-6 mb-3">
                <div class="card p-3 card-highlight bg-white shadow-sm h-100">
                    <label for="metaFile" class="form-label text-secondary fw-bold"><i class="bi bi-people-fill"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å CSV –ø–æ –í–æ–∑—Ä–∞—Å—Ç—É –∏ –ü–æ–ª—É</label>
                    <input type="file" id="metaFile" class="form-control" accept=".csv" data-type="ageGender">
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card p-3 card-highlight bg-white shadow-sm h-100">
                    <label for="placementFile" class="form-label text-secondary fw-bold"><i class="bi bi-pin-map-fill"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å CSV –ø–æ –ú–µ—Å—Ç–∞–º –†–∞–∑–º–µ—â–µ–Ω–∏—è</label>
                    <input type="file" id="placementFile" class="form-control" accept=".csv" data-type="placement">
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results">
            <!-- Initial Message -->
            <div id="initialMessage" class="text-center text-muted">
                <i class="bi bi-cloud-arrow-up" style="font-size: 4rem;"></i>
                <p class="mt-3">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤.</p>
            </div>

            <!-- Age & Gender Card -->
            <div class="card mb-5 shadow-sm" id="ageGenderCard" style="display:none;">
                <div class="card-header bg-primary text-white">
                    <h2 class="h4 mb-0"><i class="bi bi-bar-chart-line-fill"></i> –†–∞–∑–±–∏–≤–∫–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –∏ –ø–æ–ª—É</h2>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped" id="ageGenderTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="sortable">–í–æ–∑—Ä–∞—Å—Ç</th>
                                    <th class="sortable">–ü–æ–ª</th>
                                    <th class="sortable">–ó–∞—Ç—Ä–∞—Ç—ã (USD)</th>
                                    <th class="sortable">–ö–ª–∏–∫–∏</th>
                                    <th class="sortable">–ü–æ–∫–∞–∑—ã</th>
                                    <th class="sortable">–õ–∏–¥—ã</th>
                                    <th class="sortable">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                                    <th class="sortable">–ü–æ–∫—É–ø–∫–∏</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="ageGenderAnalysis"></div>
                </div>
            </div>

            <!-- Placements Card -->
            <div class="card mb-5 shadow-sm" id="placementCard" style="display:none;">
                <div class="card-header bg-success text-white">
                    <h2 class="h4 mb-0"><i class="bi bi-graph-up-arrow"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—Ç–∞–º —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</h2>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped" id="placementTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="sortable">–ú–µ—Å—Ç–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</th>
                                    <th class="sortable">–ó–∞—Ç—Ä–∞—Ç—ã (USD)</th>
                                    <th class="sortable">–ö–ª–∏–∫–∏</th>
                                    <th class="sortable">–ü–æ–∫–∞–∑—ã</th>
                                    <th class="sortable">–õ–∏–¥—ã</th>
                                    <th class="sortable">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                                    <th class="sortable">–ü–æ–∫—É–ø–∫–∏</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                     <div id="placementAnalysis"></div>
                </div>
            </div>

            <!-- Gemini Controls Card -->
            <div class="card border-primary shadow-sm mb-4" id="geminiControlsCard" style="display:none;">
                <div class="card-header bg-primary bg-opacity-10 text-primary border-primary">
                     <h4 class="h5 mb-0"><i class="bi bi-gear-wide-connected"></i> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Gemini</h4>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-5">
                            <label for="analysisTypeSelect" class="form-label">–¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞:</label>
                            <select id="analysisTypeSelect" class="form-select">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="responseStyleSelect" class="form-label">–°—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞:</label>
                            <select id="responseStyleSelect" class="form-select">
                                <option value="detailed">–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</option>
                                <option value="short">–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ —Å —Ç–∞–±–ª–∏—Ü–µ–π</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" id="generateInsightsBtn">
                                –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Å–∞–π—Ç—ã <i class="bi bi-stars"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gemini Insights Card -->
            <div class="card border-primary shadow-sm" id="geminiInsightsCard" style="display:none;">
                <div class="card-header bg-primary bg-opacity-10 text-primary border-primary">
                    <h4 class="h5 mb-0"><i class="bi bi-robot"></i> –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã –æ—Ç Gemini</h4>
                </div>
                <div class="card-body" id="geminiOutputContainer">
                    <!-- Gemini output will be rendered here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loader"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
    // --- GLOBAL STATE AND CONFIGURATION ---
    const state = {
        ageGenderData: null,
        placementData: null,
        hardcodedMapping: {
            spend: '–°—É–º–º–∞ –∑–∞—Ç—Ä–∞—Ç (USD)',
            clicks: '–ö–ª–∏–∫–∏ (–≤—Å–µ)',
            impressions: '–ü–æ–∫–∞–∑—ã',
            leads: '–õ–∏–¥—ã',
            registrations: '–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏',
            purchases: '–ü–æ–∫—É–ø–∫–∏',
            age: '–í–æ–∑—Ä–∞—Å—Ç',
            gender: '–ü–æ–ª',
            placement: '–ú–µ—Å—Ç–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è'
        }
    };
    
    // --- DOM ELEMENTS ---
    const DOMElements = {
        metaFileInput: document.getElementById('metaFile'),
        placementFileInput: document.getElementById('placementFile'),
        loadingOverlay: document.getElementById('loadingOverlay'),
        initialMessage: document.getElementById('initialMessage'),
        geminiControlsCard: document.getElementById('geminiControlsCard'),
        analysisTypeSelect: document.getElementById('analysisTypeSelect'),
        responseStyleSelect: document.getElementById('responseStyleSelect'),
        generateInsightsBtn: document.getElementById('generateInsightsBtn'),
        geminiInsightsCard: document.getElementById('geminiInsightsCard'),
        geminiOutputContainer: document.getElementById('geminiOutputContainer'),
    };

    // --- UTILITY FUNCTIONS ---
    function toggleLoader(show) {
        DOMElements.loadingOverlay.style.display = show ? 'flex' : 'none';
    }

    function formatCurrency(value) {
        return isNaN(value) || !isFinite(value) ? '0.00' : value.toFixed(2);
    }

    function sortTable(table, colIndex, isNumeric) {
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.rows);
        const sortDirection = table.dataset.sortDirection === 'asc' ? 'desc' : 'asc';
        table.dataset.sortDirection = sortDirection;
        rows.sort((a, b) => {
            let valA = a.cells[colIndex].textContent.trim();
            let valB = b.cells[colIndex].textContent.trim();
            if (isNumeric) {
                valA = parseFloat(valA.replace(/,/g, '')) || 0;
                valB = parseFloat(valB.replace(/,/g, '')) || 0;
            }
            if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
            if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });
        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));
    }
    
    function makeTableSortable(tableId, columnTypes) {
        const table = document.getElementById(tableId);
        table.querySelectorAll('th.sortable').forEach((th, i) => {
            th.addEventListener('click', () => sortTable(table, i, columnTypes[i] === 'num'));
        });
    }

    // --- GEMINI API CALL ---
    async function fetchGeminiInsights(analysisType, responseStyle, data) {
        DOMElements.geminiInsightsCard.style.display = 'block';
        DOMElements.geminiOutputContainer.innerHTML = `<div class="text-center">
            <div class="gemini-loader"></div><p class="mt-2 text-muted">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–∞–Ω–Ω—ã–µ...</p>
        </div>`;
        
        // --- Dynamic Prompt Generation ---
        let prompt;
        const detailedPrompt = `
            –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥-–∞–Ω–∞–ª–∏—Ç–∏–∫. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏ –≤ Facebook Ads.
            –î–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–æ–±–æ–π ${analysisType}.
            
            –í–æ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
            ${JSON.stringify(data, null, 2)}

            –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
            1.  –ù–∞–ø–∏—Å–∞—Ç—å –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ (summary) –ø–æ –∫–ª—é—á–µ–≤—ã–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º.
            2.  –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–∞–º—ã–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∏ —Å–∞–º—ã–µ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã/–ø–ª–µ–π—Å–º–µ–Ω—Ç—ã.
            3.  –î–∞—Ç—å 3-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö, –¥–µ–π—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∫–∞–º–ø–∞–Ω–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ù–∞–ø—Ä–∏–º–µ—Ä, –∫—É–¥–∞ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –±—é–¥–∂–µ—Ç, –∫–∞–∫–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏/–ø–ª–µ–π—Å–º–µ–Ω—Ç—ã –æ—Ç–∫–ª—é—á–∏—Ç—å, –∞ –∫–∞–∫–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å.
            
            –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ —Å–ø–∏—Å–∫–æ–≤ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏.`;
            
        const shortPrompt = `
            –¢—ã ‚Äî –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥-–∞–Ω–∞–ª–∏—Ç–∏–∫. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏ –∏–∑ JSON –Ω–∏–∂–µ.
            –î–∞–Ω–Ω—ã–µ: ${JSON.stringify(data, null, 2)}
            
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞: –î–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–∞—Ç–∫–∏–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±–µ–∑ "–≤–æ–¥—ã".
            1.  –°–æ–∑–¥–∞–π —Å–≤–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown —Å –∫–ª—é—á–µ–≤—ã–º–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏ –¥–ª—è 2-3 –ª—É—á—à–∏—Ö –∏ 1-2 —Ö—É–¥—à–∏—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤/–ø–ª–µ–π—Å–º–µ–Ω—Ç–æ–≤. –¢–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –≤–∫–ª—é—á–∞—Ç—å: –ù–∞–∑–≤–∞–Ω–∏–µ, –ó–∞—Ç—Ä–∞—Ç—ã, –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, CPL (—Ü–µ–Ω–∞ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é), –ü–æ–∫—É–ø–∫–∏, CPP (—Ü–µ–Ω–∞ –∑–∞ –ø–æ–∫—É–ø–∫—É). –†–∞—Å—Å—á–∏—Ç–∞–π CPL –∏ CPP.
            2.  –ü–æ—Å–ª–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–∏–µ –≤—ã–≤–æ–¥—ã: —É–∫–∞–∂–∏ –ª—É—á—à–∏–π –∏ —Ö—É–¥—à–∏–π —Å–µ–≥–º–µ–Ω—Ç—ã/–ø–ª–µ–π—Å–º–µ–Ω—Ç—ã, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–ø–æ–º–∏–Ω–∞—è –∏—Ö CPL –∏–ª–∏ CPP.
            3.  –î–∞–π 2-3 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞.`;

        if (responseStyle === 'short') {
            prompt = shortPrompt;
        } else {
            prompt = detailedPrompt;
        }

        try {
            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "AIzaSyAGRzczWz_loap7x6uzBNP6pjh6WJa_Xlw"; // API key will be injected by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.statusText}`);
            }

            const result = await response.json();
            
            let text = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò.';
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                text = result.candidates[0].content.parts[0].text;
            }
            
            // Basic Markdown to HTML conversion for tables
            let htmlText = text.replace(/\|/g, '</td><td>').replace(/\n/g, '</tr><tr>').replace(/<td>-+/g, '</th><th>');
            htmlText = `<table><tr>${htmlText}</tr></table>`.replace(/<\/td><td><table>/g, '<table>').replace(/<\/tr><table>/g, '<table>').replace(/<\/table><tr><td>/g, '</table>');
            
            DOMElements.geminiOutputContainer.innerHTML = `<div class="gemini-output">${htmlText}</div>`;

        } catch (error) {
            console.error('Gemini API call failed:', error);
            DOMElements.geminiOutputContainer.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Gemini API: ${error.message}</div>`;
        }
    }

    // --- CORE LOGIC ---
    function handleFileSelect(e) {
        if (!e.target.files.length) return;
        const file = e.target.files[0];
        const dataType = e.target.dataset.type;
        toggleLoader(true);

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                try {
                    const aggregatedData = aggregateData(results.data, dataType);
                    if (dataType === 'ageGender') {
                        state.ageGenderData = aggregatedData;
                        renderAgeGenderResults(aggregatedData);
                    } else {
                        state.placementData = aggregatedData;
                        renderPlacementResults(aggregatedData);
                    }
                    DOMElements.initialMessage.style.display = 'none';
                    updateGeminiControls();
                } catch (error) {
                    console.error("Processing Error:", error);
                    alert(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö: ${error.message}. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã.`);
                } finally {
                    toggleLoader(false);
                }
            },
            error: (err) => {
                toggleLoader(false);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ CSV: ${err.message}`);
            }
        });
    }
    
    function updateGeminiControls() {
        DOMElements.geminiControlsCard.style.display = 'block';
        const select = DOMElements.analysisTypeSelect;
        select.innerHTML = ''; // Clear existing options

        if (state.ageGenderData) {
            select.options.add(new Option('–ê–Ω–∞–ª–∏–∑ –ø–æ –í–æ–∑—Ä–∞—Å—Ç—É –∏ –ü–æ–ª—É', 'ageGender'));
        }
        if (state.placementData) {
            select.options.add(new Option('–ê–Ω–∞–ª–∏–∑ –ø–æ –ú–µ—Å—Ç–∞–º –†–∞–∑–º–µ—â–µ–Ω–∏—è', 'placement'));
        }
        if (state.ageGenderData && state.placementData) {
            select.options.add(new Option('–°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç (–î–µ–º–æ–≥—Ä–∞—Ñ–∏—è + –ü–ª–µ–π—Å–º–µ–Ω—Ç—ã)', 'combined'));
        }
    }

    function handleInsightGeneration() {
        const analysisType = DOMElements.analysisTypeSelect.value;
        const responseStyle = DOMElements.responseStyleSelect.value;
        let data;
        let analysisName;

        switch(analysisType) {
            case 'ageGender':
                data = state.ageGenderData;
                analysisName = '–¥–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–º –¥–∞–Ω–Ω—ã–º (–≤–æ–∑—Ä–∞—Å—Ç –∏ –ø–æ–ª)';
                break;
            case 'placement':
                data = state.placementData;
                analysisName = '–º–µ—Å—Ç–∞–º —Ä–∞–∑–º–µ—â–µ–Ω–∏—è (–ø–ª–µ–π—Å–º–µ–Ω—Ç–∞–º)';
                break;
            case 'combined':
                data = {
                    demographics: state.ageGenderData,
                    placements: state.placementData
                };
                analysisName = '—Å–≤–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º –ø–æ –¥–µ–º–æ–≥—Ä–∞—Ñ–∏–∏ –∏ –ø–ª–µ–π—Å–º–µ–Ω—Ç–∞–º';
                break;
            default:
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∞–Ω–∞–ª–∏–∑–∞');
                return;
        }

        if (data) {
            fetchGeminiInsights(analysisName, responseStyle, data);
        } else {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª.');
        }
    }

    function aggregateData(data, dataType) {
        const mapping = state.hardcodedMapping;
        const keys = dataType === 'ageGender' ? ['age', 'gender'] : ['placement'];
        const keyColumns = keys.map(k => mapping[k]);

        if (!keyColumns.every(col => data[0] && data[0].hasOwnProperty(col))) {
            throw new Error(`–û–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ (${keyColumns.join(', ')}) –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ñ–∞–π–ª–µ.`);
        }

        const aggregatedMap = new Map();
        data.forEach(row => {
            const groupKey = keyColumns.map(col => row[col] || 'N/A').join('||');
            if (!aggregatedMap.has(groupKey)) {
                const initialObject = { sumSpend: 0, clicks: 0, impressions: 0, leads: 0, regs: 0, purchases: 0 };
                keys.forEach((k, i) => initialObject[k] = row[keyColumns[i]] || 'N/A');
                aggregatedMap.set(groupKey, initialObject);
            }
            const entry = aggregatedMap.get(groupKey);
            entry.sumSpend += parseFloat(row[mapping.spend]) || 0;
            entry.clicks += parseInt(row[mapping.clicks]) || 0;
            entry.impressions += parseInt(row[mapping.impressions]) || 0;
            entry.leads += parseInt(row[mapping.leads]) || 0;
            entry.regs += parseInt(row[mapping.registrations]) || 0;
            entry.purchases += parseInt(row[mapping.purchases]) || 0;
        });
        return Array.from(aggregatedMap.values());
    }
    
    // --- RENDERING FUNCTIONS ---
    function renderAgeGenderResults(data) {
        const card = document.getElementById('ageGenderCard');
        const tableBody = card.querySelector('tbody');
        const analysisContainer = card.querySelector('#ageGenderAnalysis');
        tableBody.innerHTML = data.map(r => `
            <tr>
                <td>${r.age}</td><td>${r.gender}</td><td>${formatCurrency(r.sumSpend)}</td><td>${r.clicks}</td>
                <td>${r.impressions}</td><td>${r.leads}</td><td>${r.regs}</td><td>${r.purchases}</td>
            </tr>`).join('');
        const genderData = aggregateBy(data, ['gender']);
        const maleData = genderData.find(g => g.gender === 'male') || { sumSpend: 0, regs: 0, purchases: 0 };
        const femaleData = genderData.find(g => g.gender === 'female') || { sumSpend: 0, regs: 0, purchases: 0 };
        analysisContainer.innerHTML = `<div class="row mt-4">
                <div class="col-md-6 mb-3"><div class="card h-100 shadow-sm"><div class="card-body"><h4 class="card-title text-primary">üë• –ú—É–∂—á–∏–Ω—ã</h4><ul class="list-unstyled mb-0">
                    <li><strong>–ó–∞—Ç—Ä–∞—Ç—ã:</strong> $${formatCurrency(maleData.sumSpend)}</li><li><strong>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> ${maleData.regs}</li>
                    <li><strong>–î–µ–ø–æ–∑–∏—Ç—ã:</strong> ${maleData.purchases}</li><li><strong>CPL (—Ä–µ–≥.):</strong> $${maleData.regs ? formatCurrency(maleData.sumSpend / maleData.regs) : '-'}</li>
                    <li><strong>CPL (–¥–µ–ø.):</strong> $${maleData.purchases ? formatCurrency(maleData.sumSpend / maleData.purchases) : '-'}</li></ul></div></div></div>
                <div class="col-md-6 mb-3"><div class="card h-100 shadow-sm"><div class="card-body"><h4 class="card-title" style="color: #d63384;">üë©‚Äçü¶∞ –ñ–µ–Ω—â–∏–Ω—ã</h4><ul class="list-unstyled mb-0">
                    <li><strong>–ó–∞—Ç—Ä–∞—Ç—ã:</strong> $${formatCurrency(femaleData.sumSpend)}</li><li><strong>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> ${femaleData.regs}</li>
                    <li><strong>–î–µ–ø–æ–∑–∏—Ç—ã:</strong> ${femaleData.purchases}</li><li><strong>CPL (—Ä–µ–≥.):</strong> $${femaleData.regs ? formatCurrency(femaleData.sumSpend / femaleData.regs) : '-'}</li>
                    <li><strong>CPL (–¥–µ–ø.):</strong> $${femaleData.purchases ? formatCurrency(femaleData.sumSpend / femaleData.purchases) : '-'}</li></ul></div></div></div>
            </div>`;
        card.style.display = 'block';
    }

    function renderPlacementResults(data) {
        const card = document.getElementById('placementCard');
        const tableBody = card.querySelector('tbody');
        const analysisContainer = card.querySelector('#placementAnalysis');
        tableBody.innerHTML = data.map(r => `
            <tr>
                <td>${r.placement}</td><td>${formatCurrency(r.sumSpend)}</td><td>${r.clicks}</td><td>${r.impressions}</td>
                <td>${r.leads}</td><td>${r.regs}</td><td>${r.purchases}</td>
            </tr>`).join('');
        const topRegs = [...data].sort((a, b) => b.regs - a.regs).slice(0, 5);
        const topPurchases = [...data].sort((a, b) => b.purchases - a.purchases).slice(0, 5);
        analysisContainer.innerHTML = `<div class="row mt-4">
                <div class="col-lg-6 mb-3"><h4 class="text-success">üèÜ –¢–æ–ø –º–µ—Å—Ç –ø–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è–º</h4><ul class="list-group shadow-sm">${topRegs.map(p => `
                        <li class="list-group-item"><div class="d-flex justify-content-between"><strong>${p.placement}</strong><span class="badge bg-primary">${p.regs} —Ä–µ–≥.</span></div>
                        <div class="text-muted small">CPL –†–µ–≥: $${p.regs ? formatCurrency(p.sumSpend/p.regs) : '-'}</div></li>`).join('')}</ul></div>
                <div class="col-lg-6 mb-3"><h4 class="text-success">üí∞ –¢–æ–ø –º–µ—Å—Ç –ø–æ –¥–µ–ø–æ–∑–∏—Ç–∞–º</h4><ul class="list-group shadow-sm">${topPurchases.map(p => `
                        <li class="list-group-item"><div class="d-flex justify-content-between"><strong>${p.placement}</strong><span class="badge bg-success">${p.purchases} –¥–µ–ø.</span></div>
                        <div class="text-muted small">–¶–µ–Ω–∞ –î–µ–ø–æ–∑–∏—Ç–∞: $${p.purchases ? formatCurrency(p.sumSpend/p.purchases) : '-'}</div></li>`).join('')}</ul></div>
            </div>`;
        card.style.display = 'block';
    }
    
    function aggregateBy(data, keys) {
        const map = new Map();
        data.forEach(row => {
            const key = keys.map(k => row[k]).join('||');
            if (!map.has(key)) {
                const newEntry = { ...row };
                keys.forEach(k => newEntry[k] = row[k]);
                Object.keys(newEntry).forEach(prop => { if (typeof newEntry[prop] !== 'string') { newEntry[prop] = parseFloat(newEntry[prop]) || 0; } });
                map.set(key, newEntry);
            } else {
                const entry = map.get(key);
                Object.keys(entry).forEach(prop => { if (typeof entry[prop] === 'number') { entry[prop] += (parseFloat(row[prop]) || 0); } });
            }
        });
        return Array.from(map.values());
    }

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        DOMElements.metaFileInput.addEventListener('change', handleFileSelect);
        DOMElements.placementFileInput.addEventListener('change', handleFileSelect);
        DOMElements.generateInsightsBtn.addEventListener('click', handleInsightGeneration);
        makeTableSortable('ageGenderTable', ['str','str','num','num','num','num','num','num']);
        makeTableSortable('placementTable', ['str','num','num','num','num','num','num']);
    });
    </script>
</body>
</html>